#!/usr/bin/env bash
set -euo pipefail

VENV="${HOME}/.venvs/tts"
MODEL="${KOKORO_MODEL:-${HOME}/models/kokoro/kokoro-v1.0.onnx}"
VOICES="${KOKORO_VOICES:-${HOME}/models/kokoro/voices-v1.0.bin}"
VOICE="${KOKORO_VOICE:-}"
LANG_CODE="${KOKORO_LANG:-en-us}"

OUT=""
while getopts ":v:l:o:h" opt; do
  case "$opt" in
    v) VOICE="$OPTARG" ;;
    l) LANG_CODE="$OPTARG" ;;
    o) OUT="$OPTARG" ;;
    h) echo "usage: say-local [-v voice] [-l lang] [-o out.wav] \"text...\""; exit 0 ;;
    \?) echo "unknown option: -$OPTARG" >&2; exit 2 ;;
  esac
done
shift $((OPTIND-1))
[ $# -gt 0 ] || { echo "usage: say-local [-v voice] [-l lang] [-o out.wav] \"text...\"" >&2; exit 2; }
TEXT="$*"

# default voice if not provided
if [ -z "$VOICE" ]; then
  case "$LANG_CODE" in
    es*) VOICE="ef_dora" ;;
    *)   VOICE="af_heart" ;;
  esac
fi

TMPWAV="$(mktemp --suffix=.wav)"
K_SAY_MODEL="$MODEL" K_SAY_VOICES="$VOICES" K_SAY_TEXT="$TEXT" \
K_SAY_VOICE="$VOICE" K_SAY_LANG="$LANG_CODE" K_SAY_OUT="$TMPWAV" \
"${VENV}/bin/python" - <<'PY'
import os, soundfile as sf
from kokoro_onnx import Kokoro
k = Kokoro(os.environ['K_SAY_MODEL'], os.environ['K_SAY_VOICES'])
samples, sr = k.create(
    os.environ['K_SAY_TEXT'].replace('\n',' '),
    voice=(os.environ.get('K_SAY_VOICE') or None),
    speed=1.0,
    lang=(os.environ.get('K_SAY_LANG') or 'en-us'),
)
sf.write(os.environ['K_SAY_OUT'], samples, sr)
PY

if [ -n "$OUT" ]; then
  mv "$TMPWAV" "$OUT"; echo "Wrote $OUT"
else
  # pick exactly one player; never chain
  if   command -v aplay  >/dev/null 2>&1; then PLAYER="aplay"
  elif command -v paplay >/dev/null 2>&1; then PLAYER="paplay"
  elif command -v ffplay >/dev/null 2>&1; then PLAYER="ffplay"
  elif command -v mpv    >/dev/null 2>&1; then PLAYER="mpv"
  else PLAYER=""; fi

  set +e  # don't abort on a player's non-zero exit
  case "$PLAYER" in
    aplay)  aplay "$TMPWAV" >/dev/null 2>&1 ;;
    paplay) paplay "$TMPWAV" >/dev/null 2>&1 ;;
    ffplay) ffplay -hide_banner -loglevel error -nodisp -autoexit "$TMPWAV" ;;
    mpv)    mpv --no-video --really-quiet "$TMPWAV" ;;
    *)      echo "Saved to $TMPWAV (no audio player found)" >&2; TMPWAV="";;
  esac
  set -e
  [ -n "$TMPWAV" ] && rm -f "$TMPWAV"
fi
