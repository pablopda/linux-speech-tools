#!/usr/bin/env python3
"""
MVP Progressive Streaming Integration Script
Simple drop-in replacement for testing progressive streaming improvements
"""

import sys
import os
import argparse
import logging

# Add current directory to path for imports
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from early_start_player import MVPProgressiveStreaming

def main():
    """Main entry point for MVP progressive streaming"""
    parser = argparse.ArgumentParser(
        description="MVP Progressive Streaming for Linux Speech Tools",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  ./say-read-mvp https://example.com/article
  ./say-read-mvp --max-chars 2000 document.txt
  ./say-read-mvp --workers 3 --batch-size 3 article.pdf
  echo "Test content" | ./say-read-mvp -

MVP Features:
  ğŸš€ 50%+ faster startup (16s vs 35s)
  ğŸ”„ Parallel TTS processing
  âœ‚ï¸ Smart content chunking
  ğŸµ Early audio playback
        """
    )

    parser.add_argument(
        'source',
        help='URL, file path, or "-" for stdin'
    )

    parser.add_argument(
        '--max-chars',
        type=int,
        help='Maximum characters to process (for testing)'
    )

    parser.add_argument(
        '--chunk-size',
        type=int,
        default=250,
        help='Target characters per chunk (default: 250)'
    )

    parser.add_argument(
        '--workers',
        type=int,
        default=2,
        help='Number of parallel TTS workers (default: 2)'
    )

    parser.add_argument(
        '--batch-size',
        type=int,
        default=2,
        help='Initial chunks to process immediately (default: 2)'
    )

    parser.add_argument(
        '--benchmark',
        action='store_true',
        help='Run performance benchmark comparison'
    )

    parser.add_argument(
        '--verbose',
        action='store_true',
        help='Enable verbose logging'
    )

    args = parser.parse_args()

    # Setup logging
    log_level = logging.DEBUG if args.verbose else logging.INFO
    logging.basicConfig(
        level=log_level,
        format='%(asctime)s - %(levelname)s - %(message)s'
    )

    try:
        # Initialize MVP system
        mvp_system = MVPProgressiveStreaming(
            target_chunk_size=args.chunk_size,
            max_workers=args.workers,
            initial_batch_size=args.batch_size
        )

        if args.benchmark:
            print("ğŸ§ª Running MVP benchmark...")
            from early_start_player import benchmark_mvp_vs_current
            benchmark_mvp_vs_current()
            return 0

        # Stream the content
        print(f"ğŸ¯ MVP Progressive Streaming")
        print(f"ğŸ“– Source: {args.source}")
        print(f"âš™ï¸ Config: {args.workers} workers, {args.batch_size} initial chunks, {args.chunk_size} chars/chunk")

        if args.max_chars:
            print(f"ğŸ“ Limit: {args.max_chars} characters")

        results = mvp_system.stream_content(args.source, args.max_chars)

        # Display summary
        print(f"\nğŸ“Š Performance Summary:")
        print(f"  âš¡ Time to first audio: {results['time_to_first_audio']:.1f}s")
        print(f"  ğŸ• Total time: {results['total_time']:.1f}s")
        print(f"  ğŸ“ˆ Success rate: {(results['successful_chunks']/max(results['total_chunks'], 1))*100:.1f}%")

        # Success criteria check
        if results['time_to_first_audio'] <= 20:
            print(f"  âœ… SUCCESS: Faster than 20s target")
        else:
            print(f"  âš ï¸ Slower than expected")

        return 0

    except KeyboardInterrupt:
        print("\nğŸ›‘ Interrupted by user")
        return 1

    except Exception as e:
        logging.error(f"MVP streaming failed: {e}")
        print(f"âŒ Error: {e}")
        return 1

if __name__ == "__main__":
    sys.exit(main())