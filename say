#!/usr/bin/env bash
set -euo pipefail
# Linux Speech Tools - say command
# Use EDGE_VOICE (not VOICE) so it never collides with Kokoro settings.
VOICE="${EDGE_VOICE:-en-US-EmmaMultilingualNeural}"

# Version information
VERSION="1.0.1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/VERSION" ]]; then
    VERSION="1.0.1"
fi

show_help() {
    cat << EOF
usage: say [options] "text..."

Text-to-speech using Edge TTS

Options:
  -v voice     Voice to use (default: en-US-EmmaMultilingualNeural)
  -o output    Output file (.mp3 or .wav)
  -h, --help   Show this help message
  --version    Show version information

Examples:
  say "Hello world"
  say -v es-ES-AlvaroNeural "Hola mundo"
  say -o greeting.mp3 "Welcome to Linux Speech Tools"
EOF
}

OUT=""
while [[ $# -gt 0 ]]; do
    case $1 in
        -v)
            VOICE="$2"
            shift 2
            ;;
        -o)
            OUT="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        --version)
            echo "say (Linux Speech Tools) v$VERSION"
            exit 0
            ;;
        -*)
            echo "unknown option: $1" >&2
            echo "Try 'say --help' for more information." >&2
            exit 2
            ;;
        *)
            break
            ;;
    esac
done
[ $# -gt 0 ] || {
    echo "Error: No text provided" >&2
    echo "Try 'say --help' for more information." >&2
    exit 2
}
TEXT="$*"

if [ -n "$OUT" ]; then
  edge-tts --voice "$VOICE" --text "$TEXT" --write-media "$OUT"
  echo "Wrote $OUT"
else
  if command -v edge-playback >/dev/null 2>&1; then
    edge-playback --voice "$VOICE" --text "$TEXT"
  else
    TMP="$(mktemp --suffix=.mp3)"
    edge-tts --voice "$VOICE" --text "$TEXT" --write-media "$TMP"
    if command -v ffplay >/dev/null 2>&1; then
      ffplay -hide_banner -loglevel error -nodisp -autoexit "$TMP" || true
    elif command -v mpv >/dev/null 2>&1; then
      mpv --no-video --really-quiet "$TMP" || true
    else
      echo "Saved to $TMP (no audio player found)" >&2
    fi
  fi
fi
