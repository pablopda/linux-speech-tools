#!/usr/bin/env bash
set -euo pipefail
# Use EDGE_VOICE (not VOICE) so it never collides with Kokoro settings.
VOICE="${EDGE_VOICE:-en-US-EmmaMultilingualNeural}"

OUT=""
while getopts ":v:o:h" opt; do
  case "$opt" in
    v) VOICE="$OPTARG" ;;
    o) OUT="$OPTARG" ;;
    h) echo "usage: say [-v voice] [-o out.(mp3|wav)] \"text...\""; exit 0 ;;
    \?) echo "unknown option: -$OPTARG" >&2; exit 2 ;;
  esac
done
shift $((OPTIND-1))
[ $# -gt 0 ] || { echo "usage: say [-v voice] [-o out.(mp3|wav)] \"text...\"" >&2; exit 2; }
TEXT="$*"

if [ -n "$OUT" ]; then
  edge-tts --voice "$VOICE" --text "$TEXT" --write-media "$OUT"
  echo "Wrote $OUT"
else
  if command -v edge-playback >/dev/null 2>&1; then
    edge-playback --voice "$VOICE" --text "$TEXT"
  else
    TMP="$(mktemp --suffix=.mp3)"
    edge-tts --voice "$VOICE" --text "$TEXT" --write-media "$TMP"
    if command -v ffplay >/dev/null 2>&1; then
      ffplay -hide_banner -loglevel error -nodisp -autoexit "$TMP" || true
    elif command -v mpv >/dev/null 2>&1; then
      mpv --no-video --really-quiet "$TMP" || true
    else
      echo "Saved to $TMP (no audio player found)" >&2
    fi
  fi
fi
