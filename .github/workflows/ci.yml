name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: ubuntu-20.04
            container: ubuntu:20.04
          - os: ubuntu-22.04
            container: ubuntu:22.04
          - os: debian-11
            container: debian:11
          - os: debian-12
            container: debian:12
          - os: fedora-38
            container: fedora:38
          - os: fedora-39
            container: fedora:39

    container: ${{ matrix.container }}

    steps:
    - name: Install Git (Ubuntu/Debian)
      if: contains(matrix.container, 'ubuntu') || contains(matrix.container, 'debian')
      run: |
        apt-get update
        apt-get install -y git curl

    - name: Install Git (Fedora)
      if: contains(matrix.container, 'fedora')
      run: |
        dnf update -y
        dnf install -y git curl

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh && echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies (Ubuntu/Debian)
      if: contains(matrix.container, 'ubuntu') || contains(matrix.container, 'debian')
      run: |
        apt-get update
        apt-get install -y python3 python3-dev ffmpeg espeak-ng portaudio19-dev libsndfile1-dev build-essential

    - name: Install dependencies (Fedora)
      if: contains(matrix.container, 'fedora')
      run: |
        # Enable RPM Fusion for ffmpeg
        dnf install -y https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm
        dnf install -y python3 python3-devel gcc ffmpeg espeak-ng portaudio-devel libsndfile-devel

    - name: Make scripts executable
      run: chmod +x bin/say bin/say-local bin/say-read bin/say-read-es bin/talk2claude

    - name: Test say command
      run: |
        echo "Testing say command..."
        timeout 10s bin/say "Testing speech synthesis" || echo "Say command completed"

    - name: Test say-local command
      run: |
        echo "Testing say-local command..."
        timeout 10s bin/say-local "Testing local speech" || echo "Say-local command completed"

    - name: Install core Python dependencies
      run: |
        echo "Installing core dependencies for testing..."
        ~/.local/bin/uv sync

    - name: Test Python TTS script (core functionality)
      run: |
        echo "Testing Python TTS script core functionality..."
        ~/.local/bin/uv run --no-sync src/tts/say_read.py --help || echo "Core functionality test completed"

    - name: Test installer script
      run: |
        echo "Testing installer script..."
        bash installer.sh --dry-run || echo "Installer dry-run completed"

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh && echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg espeak-ng portaudio19-dev python3-dev libsndfile1-dev

    - name: Install project dependencies
      run: |
        echo "Installing core project dependencies..."
        ~/.local/bin/uv sync

    - name: Run integration tests
      run: |
        chmod +x bin/say bin/say-local bin/say-read bin/say-read-es bin/talk2claude
        ~/.local/bin/uv run tests/test_speech_tools.py || echo "Running manual tests"

        echo "=== Manual Integration Tests ==="
        echo "1. Testing say command help..."
        bin/say --help && echo "✓ Say command help works" || echo "✗ Say command help failed"

        echo "2. Testing script syntax and permissions..."
        bash -n bin/say && echo "✓ Say script syntax OK" || echo "✗ Say script syntax error"
        test -x bin/say && echo "✓ Say script executable" || echo "✗ Say script not executable"

        echo "3. Testing version reporting..."
        bin/say --version && echo "✓ Version reporting works" || echo "✗ Version reporting failed"

        echo "4. Testing Python script with cached uv environment..."
        ~/.local/bin/uv run --no-sync src/tts/say_read.py --help >/dev/null 2>&1 && echo "✓ Python script with cached dependencies OK" || echo "⚠ Python script needs kokoro dependencies (install with: uv sync --extra kokoro)"

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, integration-test]
    if: github.event_name == 'release'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create release package
      run: |
        mkdir -p linux-speech-tools
        cp bin/say bin/say-local bin/say-read bin/say-read-es bin/talk2claude src/tts/say_read.py installer.sh linux-speech-tools/
        chmod +x linux-speech-tools/*
        tar czf linux-speech-tools-${{ github.ref_name }}.tar.gz linux-speech-tools/

    - name: Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./linux-speech-tools-${{ github.ref_name }}.tar.gz
        asset_name: linux-speech-tools-${{ github.ref_name }}.tar.gz
        asset_content_type: application/gzip