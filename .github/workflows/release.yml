name: Release Automation

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Generate changelog
      id: changelog
      run: |
        echo "## Changes in ${{ steps.get_version.outputs.VERSION }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### Features" >> CHANGELOG.md
        echo "- Multi-engine TTS support (Edge TTS, Kokoro, Festival)" >> CHANGELOG.md
        echo "- Voice input with background recording" >> CHANGELOG.md
        echo "- Cross-distribution Linux support" >> CHANGELOG.md
        echo "- LATAM regional voice support (22 countries)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### Installation" >> CHANGELOG.md
        echo "\`\`\`bash" >> CHANGELOG.md
        echo "curl -fsSL https://raw.githubusercontent.com/pablopda/linux-speech-tools/main/installer.sh | bash" >> CHANGELOG.md
        echo "\`\`\`" >> CHANGELOG.md

    - name: Create Release
      id: create_release
      run: |
        gh release create ${{ steps.get_version.outputs.VERSION }} \
          --title "Linux Speech Tools ${{ steps.get_version.outputs.VERSION }}" \
          --notes-file CHANGELOG.md
        echo "upload_url=https://uploads.github.com/repos/$GITHUB_REPOSITORY/releases/$(gh api repos/$GITHUB_REPOSITORY/releases/tags/${{ steps.get_version.outputs.VERSION }} --jq .id)/assets" >> $GITHUB_OUTPUT
        echo "id=$(gh api repos/$GITHUB_REPOSITORY/releases/tags/${{ steps.get_version.outputs.VERSION }} --jq .id)" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-packages:
    name: Build Release Packages
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        package_type: [tar, deb, rpm]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Install packaging tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential fakeroot devscripts rpm

    - name: Create TAR package
      if: matrix.package_type == 'tar'
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        PACKAGE_NAME="linux-speech-tools-${VERSION#v}"

        mkdir -p "$PACKAGE_NAME"

        # Copy executables from bin directory
        cp -r bin/ "$PACKAGE_NAME/"

        # Copy Python sources
        cp -r src/ "$PACKAGE_NAME/"

        # Copy modern installer infrastructure
        cp installer.sh "$PACKAGE_NAME/"
        cp -r scripts/ "$PACKAGE_NAME/"

        # Copy configuration and documentation
        cp pyproject.toml "$PACKAGE_NAME/"
        cp README.md "$PACKAGE_NAME/"

        # Copy tests if they exist
        [ -d tests/ ] && cp -r tests/ "$PACKAGE_NAME/" || true

        # Create install script that uses our modern installer
        cat > "$PACKAGE_NAME/install.sh" << 'EOF'
        #!/bin/bash
        set -euo pipefail

        echo "ðŸš€ Linux Speech Tools Installation"
        echo "Using modern uv-based installer for best performance..."
        echo

        # Run the modern installer
        if [ -f "./installer.sh" ]; then
            chmod +x installer.sh
            ./installer.sh --modern "$@"
        else
            echo "âŒ Modern installer not found"
            exit 1
        fi
        EOF
        chmod +x "$PACKAGE_NAME/install.sh"

        tar czf "${PACKAGE_NAME}.tar.gz" "$PACKAGE_NAME"
        echo "PACKAGE_FILE=${PACKAGE_NAME}.tar.gz" >> $GITHUB_ENV

    - name: Create DEB package
      if: matrix.package_type == 'deb'
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        PACKAGE_VERSION="${VERSION#v}"
        PACKAGE_NAME="linux-speech-tools"

        # Create package structure
        mkdir -p "${PACKAGE_NAME}_${PACKAGE_VERSION}/DEBIAN"
        mkdir -p "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/local/bin"
        mkdir -p "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/share/doc/${PACKAGE_NAME}"

        # Copy executables
        cp bin/* "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/local/bin/"
        chmod +x "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/local/bin"/*

        # Copy complete installer infrastructure
        mkdir -p "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/share/${PACKAGE_NAME}"
        cp installer.sh "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/share/${PACKAGE_NAME}/"
        cp -r scripts/ "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/share/${PACKAGE_NAME}/"
        cp -r src/ "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/share/${PACKAGE_NAME}/"
        cp pyproject.toml "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/share/${PACKAGE_NAME}/"

        # Copy documentation
        cp README.md "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/share/doc/${PACKAGE_NAME}/"

        # Create installation note
        cat > "${PACKAGE_NAME}_${PACKAGE_VERSION}/usr/share/doc/${PACKAGE_NAME}/INSTALL" << 'EOF'
        Linux Speech Tools DEB Package

        This package includes the complete modern installer infrastructure.
        Python dependencies are automatically installed using uv for optimal performance.

        The neural TTS setup (including Kokoro) is installed automatically during
        package installation. If you need to reinstall dependencies, run:

          cd /usr/share/linux-speech-tools
          ./installer.sh --modern

        For manual installation with specific options:
          ./installer.sh --help
        EOF

        # Create control file
        cat > "${PACKAGE_NAME}_${PACKAGE_VERSION}/DEBIAN/control" << EOF
        Package: ${PACKAGE_NAME}
        Version: ${PACKAGE_VERSION}
        Section: utils
        Priority: optional
        Architecture: all
        Depends: python3, python3-pip, ffmpeg, espeak-ng
        Maintainer: Linux Speech Tools Team
        Description: Text-to-speech and voice input tools for Linux
         A comprehensive set of command-line tools for text-to-speech synthesis,
         voice input, and audio processing on Linux systems.
         .
         Features multiple TTS engines, voice recording, and cross-distribution support.
        EOF

        # Create postinst script that uses modern installer
        cat > "${PACKAGE_NAME}_${PACKAGE_VERSION}/DEBIAN/postinst" << 'EOF'
        #!/bin/bash
        set -e

        echo "ðŸš€ Linux Speech Tools: Installing modern dependencies..."

        cd /usr/share/linux-speech-tools

        # Set environment for non-interactive installation
        export DEBIAN_FRONTEND=noninteractive
        export CI=true

        # Run modern installer with fallback
        if ./installer.sh --modern 2>/dev/null; then
            echo "âœ… Modern neural TTS setup complete!"
            echo "   High-quality Kokoro neural TTS installed successfully"
        else
            echo "âš  Modern installer failed, using fallback..."

            # Fallback to basic pip installation
            if command -v pip3 >/dev/null 2>&1; then
                pip3 install --break-system-packages edge-tts pyaudio speechrecognition || \
                pip3 install edge-tts pyaudio speechrecognition
                echo "âœ… Basic TTS setup complete (Edge TTS)"
                echo "   For neural TTS quality, run: cd /usr/share/linux-speech-tools && ./installer.sh --modern"
            fi
        fi

        echo
        echo "Linux Speech Tools installed successfully!"
        echo "Usage: say 'Hello from Linux Speech Tools!'"
        EOF
        chmod 755 "${PACKAGE_NAME}_${PACKAGE_VERSION}/DEBIAN/postinst"

        # Build package
        dpkg-deb --build "${PACKAGE_NAME}_${PACKAGE_VERSION}"
        echo "PACKAGE_FILE=${PACKAGE_NAME}_${PACKAGE_VERSION}.deb" >> $GITHUB_ENV

    - name: Create RPM package
      if: matrix.package_type == 'rpm'
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        PACKAGE_VERSION="${VERSION#v}"

        # Create RPM build structure
        mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

        # Create spec file
        cat > rpmbuild/SPECS/linux-speech-tools.spec << EOF
        Name: linux-speech-tools
        Version: ${PACKAGE_VERSION}
        Release: 1%{?dist}
        Summary: Text-to-speech and voice input tools for Linux
        BuildArch: noarch

        License: MIT
        URL: https://github.com/pablopda/linux-speech-tools
        Source0: %{name}-%{version}.tar.gz

        Requires: python3, python3-pip, ffmpeg, espeak-ng

        %description
        A comprehensive set of command-line tools for text-to-speech synthesis,
        voice input, and audio processing on Linux systems.

        %prep
        %setup -q

        %install
        mkdir -p %{buildroot}/usr/local/bin
        mkdir -p %{buildroot}/usr/share/doc/%{name}
        mkdir -p %{buildroot}/usr/share/%{name}

        # Install executables
        cp bin/* %{buildroot}/usr/local/bin/
        chmod +x %{buildroot}/usr/local/bin/*

        # Install complete installer infrastructure
        cp installer.sh %{buildroot}/usr/share/%{name}/
        cp -r scripts/ %{buildroot}/usr/share/%{name}/
        cp -r src/ %{buildroot}/usr/share/%{name}/
        cp pyproject.toml %{buildroot}/usr/share/%{name}/

        # Install documentation
        cp README.md %{buildroot}/usr/share/doc/%{name}/

        %post
        echo "ðŸš€ Linux Speech Tools: Installing modern dependencies..."

        cd /usr/share/linux-speech-tools

        # Set environment for non-interactive installation
        export DEBIAN_FRONTEND=noninteractive
        export CI=true

        # Run modern installer with fallback
        if ./installer.sh --modern 2>/dev/null; then
            echo "âœ… Modern neural TTS setup complete!"
            echo "   High-quality Kokoro neural TTS installed successfully"
        else
            echo "âš  Modern installer failed, using fallback..."

            # Fallback to basic pip installation
            if command -v pip3 >/dev/null 2>&1; then
                pip3 install edge-tts pyaudio speechrecognition
                echo "âœ… Basic TTS setup complete (Edge TTS)"
                echo "   For neural TTS quality, run: cd /usr/share/linux-speech-tools && ./installer.sh --modern"
            fi
        fi

        echo
        echo "Linux Speech Tools installed successfully!"
        echo "Usage: say 'Hello from Linux Speech Tools!'"

        %files
        /usr/local/bin/*
        /usr/share/doc/%{name}/*
        /usr/share/%{name}/*

        %changelog
        * $(date "+%a %b %d %Y") GitHub Actions <noreply@github.com> - ${PACKAGE_VERSION}-1
        - Automated build from GitHub Actions
        EOF

        # Create source tarball
        mkdir "linux-speech-tools-${PACKAGE_VERSION}"
        cp -r bin/ src/ "linux-speech-tools-${PACKAGE_VERSION}/"
        cp README.md pyproject.toml "linux-speech-tools-${PACKAGE_VERSION}/"
        tar czf "rpmbuild/SOURCES/linux-speech-tools-${PACKAGE_VERSION}.tar.gz" "linux-speech-tools-${PACKAGE_VERSION}"

        # Build RPM
        rpmbuild --define "_topdir $(pwd)/rpmbuild" -ba rpmbuild/SPECS/linux-speech-tools.spec

        # Copy built RPM (check both noarch and x86_64 directories)
        if ls rpmbuild/RPMS/noarch/linux-speech-tools-*.rpm 1> /dev/null 2>&1; then
          cp rpmbuild/RPMS/noarch/linux-speech-tools-*.rpm .
        elif ls rpmbuild/RPMS/x86_64/linux-speech-tools-*.rpm 1> /dev/null 2>&1; then
          cp rpmbuild/RPMS/x86_64/linux-speech-tools-*.rpm .
        else
          echo "No RPM file found in expected locations"
          find rpmbuild/RPMS/ -name "*.rpm"
          exit 1
        fi
        RPM_FILE=$(ls linux-speech-tools-*.rpm)
        echo "PACKAGE_FILE=$RPM_FILE" >> $GITHUB_ENV

    - name: Upload Release Asset
      run: |
        VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\///')
        gh release upload $VERSION ./${{ env.PACKAGE_FILE }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-install-script:
    name: Update Installation URLs
    runs-on: ubuntu-latest
    needs: [create-release, build-packages]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Update installer with latest release
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}

        # Update installer.sh with new release URLs
        sed -i "s|LATEST_RELEASE=.*|LATEST_RELEASE=\"${VERSION#v}\"|" installer.sh
        sed -i "s|github.com/.*/releases/download/.*|github.com/$GITHUB_REPOSITORY/releases/download/$VERSION|g" installer.sh

    - name: Commit updated installer
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add installer.sh
        if ! git diff --staged --quiet; then
          git commit -m "Update installer for release ${{ steps.get_version.outputs.VERSION }}"
          git push origin main
        fi